name: Deploy and Create Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:
  publish:
    permissions:
      id-token: write # Required for authentication using OIDC
    uses: dart-lang/setup-dart/.github/workflows/publish.yml@v1
    # with:
    #   working-directory: path/to/package/within/repository
  create_release:
      runs-on: ubuntu-latest
      steps:
        - name: ðŸ“š Git Checkout
          uses: actions/checkout@v6

        - name: ðŸ“Ž Get the latest tag
          id: tag
          run: echo "tag=${GITHUB_REF##*/}" >> "$GITHUB_OUTPUT"

        - name: ðŸ“‹ Extract changelog for version
          id: changelog
          run: |
            VERSION="${{ steps.tag.outputs.tag }}"
            VERSION="${VERSION#v}"
            CHANGELOG=$(awk -v ver="$VERSION" '
              /^## / { if (found) exit; if ($2 == ver) found=1; next }
              found { print }
            ' CHANGELOG.md)
            CHANGELOG=$(echo "$CHANGELOG" | sed -e '/./,$!d' -e :a -e '/^\n*$/{$d;N;ba}')
            if [ -n "$CHANGELOG" ]; then
              {
                echo "body<<EOF"
                echo "## Changelog"
                echo ""
                echo "$CHANGELOG"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            fi

        - name: ðŸ“Œ Create GitHub release
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            CHANGELOG_BODY: ${{ steps.changelog.outputs.body }}
          run: |
            if [ -n "$CHANGELOG_BODY" ]; then
              gh release create ${{ steps.tag.outputs.tag }} \
                --notes "$CHANGELOG_BODY" \
                --generate-notes
            else
              gh release create ${{ steps.tag.outputs.tag }} --generate-notes
            fi
