name: Build and test

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - name: üìö Git Checkout
        uses: actions/checkout@v6

      - name: üê¶ Set up Dart SDK
        uses: dart-lang/setup-dart@v1.4
        with:
          sdk: stable

      - name: ‚ôªÔ∏è Restore Visual Studio Code cache (Windows)
        if: ${{ runner.os == 'Windows' }}
        id: cache-vscode
        uses: actions/cache@v4
        with:
          path: |
            C:\ProgramData\chocolatey\lib\vscode
            C:\ProgramData\chocolatey\bin\code.cmd
            C:\Program Files\Microsoft VS Code
          key: vscode-${{ runner.os }}-v1

      - name: ‚ôªÔ∏è Restore Android Studio cache (Windows)
        if: ${{ runner.os == 'Windows' }}
        id: cache-androidstudio
        uses: actions/cache@v4
        with:
          path: |
            C:\ProgramData\chocolatey\lib\androidstudio
            C:\ProgramData\chocolatey\bin\studio64.exe
            C:\Program Files\Android\Android Studio
          key: androidstudio-${{ runner.os }}-v1

      - name: üì¶ Setup Visual Studio Code
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            sudo snap install code --classic
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            brew install --cask visual-studio-code
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            if [ ! -f "/c/Program Files/Microsoft VS Code/bin/code.cmd" ]; then
              choco install vscode --yes --no-progress
            else
              echo "Visual Studio Code found in cache, skipping installation."
            fi
          fi
        shell: bash
      
      - name: ‚úîÔ∏è Verify Visual Studio Code installation
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            /snap/bin/code --version
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            "/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code" --version
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            "C:\\Program Files\\Microsoft VS Code\\bin\\code" --version
          fi
        shell: bash

      - name: üì¶ Setup Android Studio
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            sudo snap install android-studio --classic
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            brew install --cask android-studio
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            if [ ! -f "/c/Program Files/Android/Android Studio/bin/studio64.exe" ]; then
              choco install androidstudio --yes --no-progress
            else
              echo "Android Studio found in cache, skipping installation."
            fi
          fi
        shell: bash
      
      - name: ‚úîÔ∏è Verify Android Studio installation
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            /snap/bin/android-studio --version
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            "/Applications/Android Studio.app/Contents/MacOS/studio" --version
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            "C:\\Program Files\\Android\\Android Studio\\bin\\studio64.exe" --version
          fi
        shell: bash

      - name: üì¶ Install Dependencies
        run: |
          dart pub global activate coverage
          dart pub get

      - name: ‚ú® Check Formatting
        run: dart format --set-exit-if-changed .
      
      - name: üïµÔ∏è Analyze
        run: dart analyze .

      - name: üß™ Run Tests
        run: dart run test --coverage=./coverage && dart pub global run coverage:format_coverage --packages=.dart_tool/package_config.json --report-on=lib --lcov -o ./coverage/lcov.info -i ./coverage

      - name: ‚¨ÜÔ∏è Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
